Компоненты
========================
----------------
```mermaid 
flowchart LR
    A[Клиент] -->|https| C(API)
    B[Агент] -->|grpc| C(API)
    C --> |sql| D[База данных]
    B --> E[Брандмауэр] 
    
```

API
--------
В центре данной системы является сервис, написанным на языке программирования GO и обеспечивающий реализацию подходов GRPC и REST API с использованием protobuf схем и реализует интерфейс взаимодействия Агентов/Клиентов с данными хранящиеся в базе данных.

База данных
-----------
В данной системе база данных используется для хранения конфигурации и правил брандмауэра, а также для обеспечения доступа к данным через API. PostgreSQL обеспечивает надежность и стабильность работы системы, а также возможность масштабирования ее производительности в зависимости от нужд пользователей.

Агент
----------------
Агенты, установленные на узлах, осуществляют конфигурацию брандмауэра в соответствии с правилами, указанные в API. Взаимодействие агентов с API происходит через протокол gRPC, а получение конфигурации осуществляется посредством pull-запросов. 

``` mermaid
sequenceDiagram
  Агент->>Система: Запрос: список IP на интерфейсах?

  autonumber
  loop watchIPChanges
      Система->>Агент: Добавлен/Удален адрес
  end

    # процесс определения имен локальных групп безопасности
  Система-->>Агент: Ответ: контент со списком IP адресов
  Агент->> API: Запрос: группы безопасности от локальных IP
  API->> База данных: Запрос: имена групп по IPs
  База данных-->> API: Ответ: контент с именами групп
  API-->> Агент: Ответ: контент с именами групп

    # процесс определения правил для групп безопасности
  Агент->> API: Запрос: список правил для локальных групп
  API->> База данных: Запрос: список правил для списка групп
  База данных-->> API: Ответ: контент со списком правил для списка групп
  API-->> Агент: Ответ: контент со списком правил для локальных групп

    # процесс определения имен удаленных групп безопасности
  Агент->> API: Запрос: список подсетей от внешних групп безопасности
  API->> База данных: Запрос: список подсетей списка групп безопасности
  База данных-->> API: Ответ: контент со списком подсетей от списка групп безопасности
  API-->> Агент: Ответ: контент со списком подсетей от внешних групп безопасности

    # процесс формирования конфигурационного файла nftables
    Агент->> Система: Обновить конфигурацию nftables

  loop watchRuleChanges
      Агент->>API: Запрос: последняя дата обновления
      API->>База данных: Запрос: последняя дата обновления
      База данных-->>API: Ответ: последняя дата обновления
      API-->>Агент: Ответ: последняя дата обновления
  end

```

Брандмауэр
-----------
Конфигурация брандмауэра (nftables) осуществляется путем прямого обновления конфигурации через golang библиотеку для nftables. Контент формируется агентом на основе полученной от API актуальной конфигурации. В контенте указываются правила для различных типов сетевого трафика, а также для определенных протоколов и портов.
